# ТЗ: Веб-приложение «Ломбард: клиенты и договоры» (MVC, без фреймворков)

## 1. Назначение и цели
Лёгкое веб-приложение учёта клиентов и договоров (займов) ломбарда. Поддержка полного CRUD по сущностям **Клиент** и **Договор**, фильтрации, сортировки, пагинации. Архитектура — **MVC** (WSGI, без фреймворков). Обновление списков после операций в попап-окнах — через событийную модель (паттерн «Наблюдатель») и `postMessage`.

## 2. Границы системы
**Входит:** работа с клиентами и договорами; фильтры/сортировка/пагинация; попап-окна для операций; health-check.  
**Не входит:** платежи/гашение, отчётность, авторизация и роли, интеграции.

## 3. Термины и роли
- **Оператор** — пользователь системы.  
- **Клиент** — физлицо, заключившее договор.  
- **Договор** — запись о займе с суммой, сроками и статусом.  
- **Статусы договора:** `Draft` - `Active` - `Closed`.

## 4. Архитектура
- **MVC**: контроллеры — бизнес-логика и маршруты; представления — только HTML; модель — доменные классы + репозитории.
- **Наблюдатель**: `ObservableClientsRepo` генерирует события `list_ready`, `client_added`, `client_updated`, `client_deleted`; контроллеры подписаны как наблюдатели.
- **Источник данных**: PostgreSQL через `ClientsRepDBAdapter`; фильтрация/сортировка — `ClientsRepDBFilterSortDecorator`. Возможны файловые репозитории JSON/YAML (совместимый интерфейс).
- **Попап-окна**: все CRUD-операции открываются во всплывающих окнах; по успеху — `postMessage` в родителя и автозакрытие.

## 5. Функциональные требования

### 5.1 Клиенты
- **Список `/`**: колонки ID, ФИО (Фамилия + инициалы), контакт (телефон/email), паспорт.  
  Фильтры по Ф/И/О (подстроки), телефон/email (подстроки), серия/номер паспорта (точно), дата рождения (диапазон).  
  Сортировка: `id`, `last_name`, `birth_date` (ASC/DESC).  
  Пагинация: `k` (страница), `n` (размер).  
  Действия: «Открыть» (деталь, новая вкладка), «Редактировать» (попап), «Удалить» (подтверждение, попап).  
  Кнопки: «Добавить клиента» (попап), **«Контракты»** (переход на `/contracts`).
- **Деталь `/client/detail?id=…`**: полный состав полей + действия «Редактировать», «Удалить».
- **Добавление/Редактирование/Удаление**: валидация обязательных полей, по успеху — обновление списка родителя.

### 5.2 Договоры
- **Список `/contracts`**: ID, №, **Клиент (ФИО)**, Сумма, Статус, Окончание, действия (Откр/Изм/Закрыть).  
  Фильтры: № (подстрока), клиент (id/ФИО), статус, даты начала/окончания (диапазоны).  
  Сортировка: `id`, `number`, `end_date` (ASC/DESC).  
  Пагинация: `k`, `n`.  
  **Имя-сервис**: перед рендером к коллекции контрактов подмешиваются ФИО клиентов по `client_id`.
- **Деталь `/contract/detail?id=…`**: полный состав полей, ФИО клиента.  
- **Создание/Редактирование/Закрытие**: попап-формы; `Active → Closed`.

### 5.3 Health-check
`/debug/health` — текущий источник данных и число записей (200/500).

## 6. Нефункциональные требования
- Производительность: ≤ 200 мс на выдачу списка при 1–5 тыс. записей (локально).  
- Надёжность: сообщения валидации с сохранением введённых значений.  
- Безопасность: экранирование HTML.  
- Совместимость: Chrome/Edge/Firefox (актуальные), Python 3.11+, PostgreSQL 14+.

## 7. Бизнес-правила и валидация
**Клиент** (обяз.): `last_name`, `first_name`, `middle_name`, `passport_series(4циф.)`, `passport_number(6циф.)`, `birth_date (ДД-ММ-ГГГГ)`, `phone`, `email`, `address`.  
**Договор**: `number` не пуст; `principal > 0`; `start_date ≤ end_date`; `status ∈ {Draft, Active, Closed}`; переходы `Draft→Active`, `Active→Closed`; `client_id` ссылается на существующего клиента.

## 8. Модель (ООП, кратко)
- `Client` (валидация, форматированные представления)
- `ClientShort` (вывод для списков)
- `Contract` (доменная сущность)
- `BaseClientsRepo` (абстрактный), `ClientsRepDBAdapter` (PostgreSQL)
- `ClientsRepDBFilterSortDecorator` (filter/sort)
- `ObservableClientsRepo` (Subject)
- `ContractsLiteRepo` (+ `ContractFilter`, `ContractSort`)
- `ContractsLiteNameService` (подстановка ФИО по `client_id`)
- Контроллеры: `MainController` (клиенты), `AddClientController`, `EditClientController`, `DeleteClientController`, `ContractsLiteController`
- Представления: `web_views`, `contracts_lite_views`

## 9. Маршруты
| Маршрут                  | Метод | Описание                                   |
|--------------------------|-------|--------------------------------------------|
| `/`                      | GET   | Список клиентов                            |
| `/client/select?id=…`    | GET   | Маркировка выбранного + редирект на деталь |
| `/client/detail?id=…`    | GET   | Деталь клиента                             |
| `/client/add`            | GET   | Попап добавления                           |
| `/client/create`         | POST  | Создание клиента                           |
| `/client/edit?id=…`      | GET   | Попап редактирования                       |
| `/client/update`         | POST  | Сохранение клиента                         |
| `/client/delete?id=…`    | GET   | Попап подтверждения удаления               |
| `/client/delete/confirm` | POST  | Удаление                                   |
| `/contracts`             | GET   | Список договоров                           |
| `/contract/detail?id=…`  | GET   | Деталь договора                            |
| `/contract/add`          | GET   | Попап создания договора                    |
| `/contract/create`       | POST  | Создание договора                          |
| `/contract/edit?id=…`    | GET   | Попап редактирования договора              |
| `/contract/update`       | POST  | Сохранение договора                        |
| `/contract/close?id=…`   | GET   | Попап подтверждения закрытия               |
| `/contract/close/do`     | POST  | Закрытие договора                          |
| `/debug/health`          | GET   | Health-check                               |

## 10. Сценарии пользователя
1) Просмотр/поиск/сортировка/пагинация по клиентам.  
2) Открытие карточки клиента.  
3) Создание/редактирование/удаление клиента (попап).  
4) Переход «Контракты» - список договоров.  
5) Фильтры/сорт/пагинация по договорам.  
6) Создание/редактирование/закрытие договора (попап).  
7) Деталь договора.  
8) Health-check.

---

## 12. Событийная модель

Репозиторий клиентов генерирует: list_ready, client_added, client_updated, client_deleted.

Попапы по успеху выполняют window.opener.postMessage({type: ...}); родитель слушает и перезагружает список.

---

## 13. Установка и запуск

Python 3.11+, PostgreSQL 14+.

Конфиг БД: host/port/db/user/password, auto_migrate=True.

Запуск: python web_app/web_app.py → http://127.0.0.1:8000/.

---

## 14. Критерии приёмки

CRUD по клиентам и договорам из UI.

Фильтры/сорт/пагинация корректно работают и отражаются в URL.

После операций в попапах список обновляется без F5.

В /contracts колонка «Клиент» выводит ФИО, не client_id.

Переходы статусов договоров соблюдаются.